#!/bin/sh

# get the tus id (tguid), current byte offset and total size of the upload
id="$TUS_ID"
offset="$TUS_OFFSET"
size="$TUS_SIZE"

first_update=false
if [ ! -f "/tmp/$id.txt" ]; then
    echo "INFO: Latest offset file NOT found"
    first_update=true
else
    echo "INFO: Found latest offset file"

    # read the latest offset (for debug purposes)
    read -rd '' latest_offset </tmp/$id.txt || :

    # calculate elapsed seconds since last modified timestamp of latest offset file
    last_modified_epoch=`stat -c %Y /tmp/$id.txt`
    now_epoch=`date +%s`
    elapsed_seconds=$(expr \( $now_epoch - $last_modified_epoch \))

    echo "INFO: offset = $offset, latest offset = $latest_offset, now epoch = $now_epoch, last modified epoch = $last_modified_epoch, elapsed sec = $elapsed_seconds"
fi

if [ "$first_update" == true ] || [ $elapsed_seconds -ge "1" ] || [ "$offset" -eq "$size" ]; then
    echo "INFO: Updating latest offset file and processing update"
    
    # update the latest offset in the temporary file
    echo $offset > /tmp/$id.txt

    # run the python standalone binary to update the upload status
    ./post-receive-bin --id $id --offset $offset --size $size
else
    echo "INFO: Skipping update"
fi
