name: Tus Hook CI Template

on:
  workflow_call: # Reusable workflow trigger.
    inputs:
      HOOK_NAME:
        type: string
        description: "Name of tus hook (pre-create|post-receive|post-terminate)"
        required: true
      WORKING_DIRECTORY:
        type: string
        description: "Subdirectory where the hook script files are located."
        required: true
      BUILD_SCRIPT:
        type: string
        description: "Name of shell script used to build the portable binary hook file."
        required: true

jobs:
  unit-test:
    name: Unit Test
    runs-on: [self-hosted, python3]
    defaults:
      run:
        working-directory: ${{ inputs.WORKING_DIRECTORY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Run Unit Tests
        run: python3 -m unittest discover
  build-artifact:
    name: Build Artifact
    runs-on: ubuntu-latest
    needs: unit-test
    defaults:
      run:
        working-directory: ${{ inputs.WORKING_DIRECTORY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Log in with Azure
        uses: azure/login@v1
        with:
          creds: "${{ secrets.AZURE_CREDENTIALS }}"
      - name: Log into ACR
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az acr login --name ociodexdevupload
      - name: Build
        run: ./${{ inputs.BUILD_SCRIPT }};
