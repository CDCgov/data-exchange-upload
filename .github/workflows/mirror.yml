name: "Mirror To CDC Gov"

on: [workflow_dispatch, push]

jobs:
  get-install-token:
    name: "Get Install Token"
    runs-on: ubuntu-latest
    outputs:
      jwt: ${{ steps.get-jwt.outputs.jwt }}
      installToken: ${{ steps.get-token.outputs.token }}
    defaults:
      run:
        working-directory: .github/workflows/scripts
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install jwt
        run: pip install jwt
      - name: Create key file
        run: echo ${{ secrets.CDCENT_CDCGOV_SYNC_PRIVATE_KEY }} >> key.pem
      - name: Generate JWT
        id: get-jwt
        run: python generate-jwt.py --pem key.pem --app-id ${{ secrets.CDCENT_CDCGOV_SYNC_APP_ID }} >> "$GITHUB_OUTPUT"
      - name: Get Install Token
        id: get-token
        run: ./get-install-access-token.sh ${{ steps.get-jwt.outputs.jwt }} ${{ secrets.CDCENT_CDCGOV_SYNC_INSTALLATION_ID }} >> "$GITHUB_OUTPUT"
  mirror:
    name: "Mirror Commits To CDC Gov"
    runs-on: ubuntu-latest
    needs: get-install-token
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Clone to CDCGov
        env:
          GITHUB_TOKEN: ${{ needs.get-install-token.outputs.token }}
        run: git push --mirror git@github.com:CDCgov/data-exchange-upload.git
